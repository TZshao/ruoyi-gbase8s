<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hfits.system.workflow.mapper.FlowStepDefMapper">

    <resultMap type="com.hfits.system.workflow.domain.FlowStepDef" id="FlowStepDefResult">
        <id     property="id"            column="id"/>
        <result property="flowId"        column="flow_id"/>
        <result property="stepCode"      column="step_code"/>
        <result property="stepName"      column="step_name"/>
        <result property="nextOnPass"    column="next_on_pass"/>
        <result property="nextOnReject"  column="next_on_reject"/>
        <result property="handlerType"   column="handler_type"/>
        <result property="handlerValue"  column="handler_value"/>
        <result property="eventOnPass"   column="event_on_pass"/>
        <result property="eventOnReject" column="event_on_reject"/>
        <result property="orderNum"      column="order_num"/>
        <result property="createBy"      column="create_by"/>
        <result property="createTime"    column="create_time"/>
        <result property="updateBy"      column="update_by"/>
        <result property="updateTime"    column="update_time"/>
        <result property="remark"        column="remark"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, flow_id, step_code, step_name, next_on_pass, next_on_reject, handler_type, handler_value, event_on_pass, event_on_reject, order_num, create_by, create_time, update_by, update_time, remark
    </sql>

    <select id="selectById" parameterType="Long" resultMap="FlowStepDefResult">
        select <include refid="Base_Column_List"/> from flow_step_def where id = #{id}
    </select>

    <select id="selectByFlowIdAndCode" resultMap="FlowStepDefResult">
        select <include refid="Base_Column_List"/> from flow_step_def where flow_id = #{flowId} and step_code = #{stepCode}
    </select>

    <select id="selectNextStep" resultType="com.hfits.system.workflow.domain.FlowStepDef">
        select t2.<include refid="Base_Column_List"/>
        from flow_step_def t1
            join flow_step_def t2
                on t2.step_code = t1.nextOnPass and t2.flow_id = t1.flow_id
        where t1.flow_id = #{flowId}
        and t1.step_code = #{stepCode}
    </select>


    <select id="selectFirstStepCode" parameterType="Long" resultType="String">
        select step_code from flow_step_def where flow_id = #{flowId} order by order_num asc limit 1
    </select>

    <select id="selectFlowStepDefList" parameterType="FlowStepDef" resultMap="FlowStepDefResult">
        select <include refid="Base_Column_List"/> from flow_step_def
        <where>
            <if test="flowId != null">
                and flow_id = #{flowId}
            </if>
            <if test="stepCode != null and stepCode != ''">
                and step_code like concat('%', #{stepCode}, '%')
            </if>
            <if test="stepName != null and stepName != ''">
                and step_name like concat('%', #{stepName}, '%')
            </if>
        </where>
        order by order_num asc, id asc
    </select>

    <insert id="insertFlowStepDef" parameterType="FlowStepDef" useGeneratedKeys="true" keyProperty="id">
        insert into flow_step_def(
            <trim suffixOverrides=",">
                <if test="flowId != null">flow_id,</if>
                <if test="stepCode != null">step_code,</if>
                <if test="stepName != null">step_name,</if>
                <if test="nextOnPass != null">next_on_pass,</if>
                <if test="nextOnReject != null">next_on_reject,</if>
                <if test="handlerType != null">handler_type,</if>
                <if test="handlerValue != null">handler_value,</if>
                <if test="eventOnPass != null">event_on_pass,</if>
                <if test="eventOnReject != null">event_on_reject,</if>
                <if test="orderNum != null">order_num,</if>
                <if test="remark != null">remark,</if>
                <if test="createBy != null">create_by,</if>
                <if test="createTime != null">create_time,</if>
            </trim>
        ) values(
            <trim suffixOverrides=",">
                <if test="flowId != null">#{flowId},</if>
                <if test="stepCode != null">#{stepCode},</if>
                <if test="stepName != null">#{stepName},</if>
                <if test="nextOnPass != null">#{nextOnPass},</if>
                <if test="nextOnReject != null">#{nextOnReject},</if>
                <if test="handlerType != null">#{handlerType},</if>
                <if test="handlerValue != null">#{handlerValue},</if>
                <if test="eventOnPass != null">#{eventOnPass},</if>
                <if test="eventOnReject != null">#{eventOnReject},</if>
                <if test="orderNum != null">#{orderNum},</if>
                <if test="remark != null">#{remark},</if>
                <if test="createBy != null">#{createBy},</if>
                <if test="createTime != null">#{createTime},</if>
            </trim>
        )
    </insert>

    <update id="updateFlowStepDef" parameterType="FlowStepDef">
        update flow_step_def
        <set>
            <if test="flowId != null">flow_id = #{flowId},</if>
            <if test="stepCode != null">step_code = #{stepCode},</if>
            <if test="stepName != null">step_name = #{stepName},</if>
            <if test="nextOnPass != null">next_on_pass = #{nextOnPass},</if>
            <if test="nextOnReject != null">next_on_reject = #{nextOnReject},</if>
            <if test="handlerType != null">handler_type = #{handlerType},</if>
            <if test="handlerValue != null">handler_value = #{handlerValue},</if>
            <if test="eventOnPass != null">event_on_pass = #{eventOnPass},</if>
            <if test="eventOnReject != null">event_on_reject = #{eventOnReject},</if>
            <if test="orderNum != null">order_num = #{orderNum},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        where id = #{id}
    </update>

    <delete id="deleteFlowStepDefById" parameterType="Long">
        delete from flow_step_def where id = #{id}
    </delete>

    <delete id="deleteFlowStepDefByIds" parameterType="Long">
        delete from flow_step_def where id in
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>

